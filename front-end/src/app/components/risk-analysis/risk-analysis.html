<div class="risk-analysis-container">
  
  <!-- Analysis Trigger Card (Shows before analysis) -->
  <div class="analysis-trigger-card" *ngIf="!analysisComplete && !isAnalyzing">
    <div class="trigger-icon">
      <i class="fa-solid fa-brain"></i>
    </div>
    <h2>Ready to Analyze Your Tax Data</h2>
    <p>Our AI-powered system will analyze your uploaded documents and generate comprehensive risk insights in real-time.</p>
    <button class="start-analysis-btn" (click)="startAnalysis()">
      <i class="fa-solid fa-sparkles"></i>
      Start Complete Analysis
    </button>
    <div class="features-list">
      <div class="feature">
        <i class="fa-solid fa-check-circle"></i>
        <span>AI-powered risk detection</span>
      </div>
      <div class="feature">
        <i class="fa-solid fa-check-circle"></i>
        <span>Real-time financial insights</span>
      </div>
      <div class="feature">
        <i class="fa-solid fa-check-circle"></i>
        <span>Automated compliance checks</span>
      </div>
    </div>
  </div>

  <!-- Loading State (Shows during analysis) -->
  <div class="analysis-loading-card" *ngIf="isAnalyzing">
    <div class="loading-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-icon">
        <i class="fa-solid fa-brain"></i>
      </div>
    </div>
    <h2>Analyzing Your Financial Data</h2>
    <p class="loading-step">{{ currentStep }}</p>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="progressPercent"></div>
    </div>
    <p class="progress-text">{{ progressPercent | number:'1.0-0' }}% Complete</p>
  </div>

  <!-- Main Content (Shows after analysis complete) -->
  <div class="main-content" *ngIf="analysisComplete" [@fadeIn]>
    
    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <h1>
          <i class="fa-solid fa-sparkles completed-icon"></i>
          Tax Risk Analysis
        </h1>
        <p class="subtitle">AI-powered insights across your key financial metrics</p>
      </div>
      
      <div class="filter-bar">
        <div class="filter-group">
          <div class="filter-item">
            <label>Period</label>
            <select class="filter-select">
              <option>Month</option>
              <option>Quarter</option>
              <option selected>Year</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Currency</label>
            <select class="filter-select">
              <option>USD</option>
              <option selected>KES</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Date Range</label>
            <input type="date" class="filter-input" value="2024-01-01">
            <span class="date-separator">to</span>
            <input type="date" class="filter-input" value="2024-12-31">
          </div>
        </div>
        
        <button class="download-btn">
          <i class="fa-solid fa-file-pdf"></i>
          Download Report
        </button>
      </div>
    </div>

    <!-- Summary Metrics Cards -->
    <div class="metrics-grid">
      <div class="metric-card" [class]="metric.color" *ngFor="let metric of metrics" [@slideIn]>
        <div class="metric-icon">
          <i class="fa-solid" [class]="metric.icon"></i>
        </div>
        <div class="metric-content">
          <h3>{{ metric.title }}</h3>
          <div class="metric-value">
            <span class="value">{{ metric.value }}</span>
            <span class="trend" [class]="metric.trendDirection">
              <i class="fa-solid" 
                 [class.fa-arrow-trend-up]="metric.trendDirection === 'up'"
                 [class.fa-arrow-trend-down]="metric.trendDirection === 'down'"
                 [class.fa-minus]="metric.trendDirection === 'stable'"></i>
              {{ metric.trend }}
            </span>
          </div>
          <div class="risk-label" [class]="metric.riskLevel">
            <span class="indicator"></span>
            {{ metric.riskLabel }}
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section" *ngIf="showCharts" [@fadeIn]>
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <h2>Financial Risk Trend</h2>
            <p>Monthly risk index tracking across key metrics</p>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <span class="dot turnover"></span>
              <span>Turnover</span>
            </div>
            <div class="legend-item">
              <span class="dot payroll"></span>
              <span>Payroll</span>
            </div>
            <div class="legend-item">
              <span class="dot vat"></span>
              <span>VAT</span>
            </div>
            <div class="legend-item">
              <span class="dot refunds"></span>
              <span>Refunds</span>
            </div>
          </div>
        </div>
        
        <div class="risk-zones">
          <div class="zone high">High Risk (70-100)</div>
          <div class="zone medium">Medium Risk (40-69)</div>
          <div class="zone low">Low Risk (0-39)</div>
        </div>
        
        <div class="chart-container">
          <canvas id="riskTrendChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Breakdown Section -->
    <div class="breakdown-section" [@fadeIn]>
      <!-- Left Column: Data Table -->
      <div class="breakdown-card table-card">
        <div class="card-header">
          <h2>Detailed Risk Breakdown</h2>
          <button class="export-btn">
            <i class="fa-solid fa-download"></i>
            Export
          </button>
        </div>
        
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Variance %</th>
                <th>Category Risk</th>
                <th>Last Updated</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of tableData" [@slideIn]>
                <td>
                  <div class="metric-cell">
                    <i class="fa-solid" [class]="row.icon" [style.color]="row.iconColor"></i>
                    <span>{{ row.metric }}</span>
                  </div>
                </td>
                <td>
                  <span class="variance" [class.positive]="row.isPositive" [class.negative]="!row.isPositive">
                    {{ row.variance }}
                  </span>
                </td>
                <td>
                  <span class="risk-chip" [class]="row.risk">
                    {{ row.risk === 'high' ? 'High' : row.risk === 'medium' ? 'Medium' : row.risk === 'low' ? 'Low' : 'Pending' }}
                  </span>
                </td>
                <td>
                  <span class="timestamp">{{ row.timestamp }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Right Column: AI Insights -->
      <div class="breakdown-card insights-card">
        <div class="card-header">
          <h2>
            <i class="fa-solid fa-sparkles ai-icon"></i>
            AI Observations
          </h2>
          <span class="confidence-badge">95% Confidence</span>
        </div>
        
        <div class="insights-content">
          <div class="insight-item" 
               [class.high-priority]="insight.priority === 'critical'"
               [class.medium-priority]="insight.priority === 'warning'"
               [class.low-priority]="insight.priority === 'info'"
               *ngFor="let insight of insights" [@slideIn]>
            <div class="insight-header">
              <span class="priority-badge" [class]="insight.priority">
                {{ insight.priority === 'critical' ? 'Critical' : insight.priority === 'warning' ? 'Warning' : 'Info' }}
              </span>
              <span class="insight-time">Detected {{ insight.time }}</span>
            </div>
            <h3>{{ insight.title }}</h3>
            <p>{{ insight.description }}</p>
            <div class="insight-action" *ngIf="!insight.hasMetrics">
              <button class="action-btn primary">Review Details</button>
              <button class="action-btn secondary">Dismiss</button>
            </div>
            <div class="insight-metrics" *ngIf="insight.hasMetrics">
              <div class="mini-metric">
                <span class="label">Average Claim</span>
                <span class="value">KSh 240K</span>
              </div>
              <div class="mini-metric">
                <span class="label">Processing Time</span>
                <span class="value">14 days</span>
              </div>
            </div>
          </div>

          <div class="insight-sparkline" *ngIf="showSparkline" [@fadeIn]>
            <h4>Risk Score Trend (7 days)</h4>
            <div class="sparkline-container">
              <canvas id="sparklineChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Section -->
    <div class="page-footer" [@fadeIn]>
      <div class="footer-info">
        <i class="fa-solid fa-clock"></i>
        <span>Last analysis: <strong>Just now</strong></span>
        <span class="separator">â€¢</span>
        <span>Next scheduled: <strong>Tomorrow at 9:00 AM</strong></span>
      </div>
      
      <button class="generate-report-btn">
        <i class="fa-solid fa-file-lines"></i>
        Generate Full Report
      </button>
    </div>
  </div>

</div>